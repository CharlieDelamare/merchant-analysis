<!-- FILE: index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Merchant Invoice Analysis</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    #loadingMessage {
      display: none;
      font-weight: bold;
      color: blue;
    }
    #output {
      width: 80%;
      margin: 20px auto;
      text-align: left;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    #dropZone {
  border: 2px dashed #ccc;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  margin-bottom: 10px;
}

#dropZone.dragover {
  background-color: #f0f0f0;
}

  </style>
</head>
<body>
    <h2>Upload Merchant Invoices (Drag & Drop or Select Files)</h2>

    <div id="dropZone">
      <p>Drag & drop your PDF files here or click to select files.</p>
      <input type="file" id="fileInput" multiple accept="application/pdf" />
    </div>
    
    <button onclick="uploadFiles()">Upload</button>
    
    <p id="loadingMessage">Analyzing... Please wait.</p>
    <div id="output"></div>
    <h3>Upload History</h3>
<ul id="historyList"></ul>

  <script>
 document.addEventListener("DOMContentLoaded", () => {
  const dropZone = document.getElementById("dropZone");
  const fileInput = document.getElementById("fileInput");

  // Handle click to open file dialog
  dropZone.addEventListener("click", () => fileInput.click());

  // Handle drag events
  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("dragover");
  });

  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("dragover");
  });

  // Handle dropped files
  dropZone.addEventListener("drop", (e) => {
  e.preventDefault();
  dropZone.classList.remove("dragover");

  const droppedFiles = [...e.dataTransfer.files]; // Convert FileList to array

  if (droppedFiles.length === 0) {
    alert("No files detected.");
    return;
  }

  uploadFiles(droppedFiles); // Pass files properly
});
});

async function uploadFiles(files = null) {
  const fileInput = document.getElementById("fileInput");
  const loadingMessage = document.getElementById("loadingMessage");
  const outputDiv = document.getElementById("output");

  // Get files from input if no files were passed (from drag & drop)
  const selectedFiles = files || [...fileInput.files];

  if (selectedFiles.length === 0) {
    alert("Please select at least one file.");
    return;
  }

  loadingMessage.style.display = "block";
  outputDiv.innerHTML = "";

  let history = JSON.parse(localStorage.getItem("statementHistory")) || [];

  for (let file of selectedFiles) {
    const formData = new FormData();
    formData.append("merchantStatement", file);

    try {
      const response = await fetch("https://merchant-analysis.onrender.com/upload", {
        method: "POST",
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || "Upload failed");
      }

      const data = await response.json();
      outputDiv.innerHTML += formatTable(data.analysis) + "<br>";

      // âœ… Save to history
      history.push({
        filename: file.name,
        data: data.analysis,
        timestamp: new Date().toISOString()
      });

      localStorage.setItem("statementHistory", JSON.stringify(history));
    } catch (error) {
      outputDiv.innerHTML += `<p style="color: red;">Error processing ${file.name}: ${error.message}</p>`;
    }
  }

  loadingMessage.style.display = "none";
  displayHistory();
}

    function formatTable(markdown) {
  if (!markdown.includes('|')) return `<pre>${markdown}</pre>`;

  const rows = markdown.split("\n").filter(row => row.includes("|") && !row.includes("---"));
  let html = "<table>";

  // Extract header row and remove it from the data rows
  let headerRow = rows.shift(); // This assumes the first row is the header
  let dataRows = [];

  // Define sorting order
  const order = ["Visa", "MasterCard", "Amex", "Other", "Total"];

  rows.forEach((row) => {
    let cols = row.split("|").map(cell => cell.trim());
    if (cols.length > 2) {
      let rowData = cols.slice(1, -1); // Remove first and last empty columns
      dataRows.push(rowData);
    }
  });

  // Sort the data rows based on the predefined order
  dataRows.sort((a, b) => {
    let indexA = order.indexOf(a[0]) !== -1 ? order.indexOf(a[0]) : order.length;
    let indexB = order.indexOf(b[0]) !== -1 ? order.indexOf(b[0]) : order.length;
    return indexA - indexB;
  });

  // Add the header row at the top
  let headerCols = headerRow.split("|").map(cell => `<th>${cell.trim()}</th>`).slice(1, -1); // Trim and format as <th>
  html += `<tr>${headerCols.join("")}</tr>`;

  // Rebuild table rows in the correct order, applying bold formatting for the totals row
  dataRows.forEach(row => {
    let isTotalRow = row[0].toLowerCase().includes("total");

    html += `<tr>${row
      .map(cell => {
        // Remove any Markdown bold (`**text**`) and replace it with `<b>text</b>`
        let cleanCell = cell.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
        return isTotalRow ? `<td><b>${cleanCell}</b></td>` : `<td>${cleanCell}</td>`;
      })
      .join("")}</tr>`;
  });

  return html + "</table>";
}

function displayHistory() {
  const historyList = document.getElementById("historyList");
  const history = JSON.parse(localStorage.getItem("statementHistory")) || [];

  historyList.innerHTML = "";

  history.forEach((entry, index) => {
    const li = document.createElement("li");
    li.innerHTML = `<b>${entry.filename}</b> - ${new Date(entry.timestamp).toLocaleString()} 
      <button onclick="downloadCSV(${index})">ðŸ“¥ Download CSV</button>
      <button onclick="shareResult(${index})">ðŸ”— Share</button>`;
    historyList.appendChild(li);
  });
}

// Call on page load
document.addEventListener("DOMContentLoaded", () => {
  displayHistory(); // Load history on page load

  // âœ… Handle shared data from URL
  const urlParams = new URLSearchParams(window.location.search);
  const sharedData = urlParams.get("data");

  if (sharedData) {
    document.getElementById("output").innerHTML = formatTable(decodeURIComponent(sharedData));
  }
});

function downloadCSV(index) {
  const history = JSON.parse(localStorage.getItem("statementHistory")) || [];
  const entry = history[index];

  if (!entry) return alert("No data found for this statement.");

  // Convert Markdown table to CSV
  const markdownTable = entry.data;
  const rows = markdownTable.split("\n").filter(row => row.includes("|") && !row.includes("---"));

  let csvContent = "data:text/csv;charset=utf-8,";

  // Extract headers and format correctly
  const headerRow = rows.shift().split("|").map(cell => cell.trim()).slice(1, -1).join(",");
  csvContent += headerRow + "\n";

  rows.forEach((row) => {
    const cols = row.split("|").map(cell => cell.trim());
    csvContent += cols.slice(1, -1).join(",") + "\n";
  });

  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `${entry.filename.replace(".pdf", "")}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function shareResult(index) {
  const history = JSON.parse(localStorage.getItem("statementHistory")) || [];
  const entry = history[index];

  if (!entry) return alert("No data found for this statement.");

  const encodedData = encodeURIComponent(entry.data);
  const shareableLink = `${window.location.origin}${window.location.pathname}?data=${encodedData}`;

  navigator.clipboard.writeText(shareableLink).then(() => {
    alert("ðŸ”— Link copied! You can now share this result.");
  }).catch(err => console.error("Failed to copy:", err));
}
  </script>
</body>
</html>